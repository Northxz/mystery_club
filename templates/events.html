{% extends "base.html" %}

{% block title %}Events - Mystery Club{% endblock %}

{% block extra_head %}
<script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.js'></script>
{% endblock %}

{% block content %}
<div class="container">
    <div class="row">
        <div class="col-12">
            <h1 class="mb-4 text-gradient">
                <i class="fas fa-calendar me-2"></i>Event Planning & Calendar
            </h1>
        </div>
    </div>

    <div class="row">
        <div class="col-md-4 mb-4">
            <div class="card slide-in-right">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-plus me-2"></i>Add New Event
                    </h5>
                </div>
                <div class="card-body">
                    <form method="POST" action="{{ url_for('add_event_route') }}" id="eventForm">
                        <div class="mb-3">
                            <label for="name" class="form-label">Event Name</label>
                            <input type="text" class="form-control" id="name" name="name" 
                                   placeholder="e.g., Mystery Game Night" required>
                        </div>
                        <div class="mb-3">
                            <label for="date" class="form-label">Date</label>
                            <input type="date" class="form-control" id="date" name="date" required>
                        </div>
                        <div class="mb-3">
                            <label for="time" class="form-label">Time</label>
                            <input type="time" class="form-control" id="time" name="time" required>
                        </div>
                        <div class="mb-3">
                            <label for="location" class="form-label">Location</label>
                            <input type="text" class="form-control" id="location" name="location" 
                                   placeholder="e.g., Community Center, Room 101" required>
                        </div>
                        <div class="mb-3">
                            <label for="description" class="form-label">Description</label>
                            <textarea class="form-control" id="description" name="description" 
                                      rows="3" placeholder="Event details and agenda" required></textarea>
                        </div>
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-save me-1"></i>Add Event
                        </button>
                    </form>
                </div>
            </div>

            <!-- Upcoming Events Sidebar -->
            <div class="card mt-4 fade-in-up">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-clock me-2"></i>Upcoming Events
                    </h5>
                </div>
                <div class="card-body">
                    {% if events %}
                        {% set upcoming_events = [] %}
                        {% for event in events %}
                            {% if event['Date'] >= moment().format('YYYY-MM-DD') %}
                                {% set _ = upcoming_events.append(event) %}
                            {% endif %}
                        {% endfor %}
                        
                        {% if upcoming_events %}
                            {% for event in upcoming_events[:5] %}
                            <div class="upcoming-event mb-3 p-2 border-start border-primary border-3">
                                <h6 class="mb-1 fw-bold">{{ event['Event Name'] }}</h6>
                                <small class="text-muted">
                                    <i class="fas fa-calendar me-1"></i>{{ event['Date'] }}
                                    <i class="fas fa-clock ms-2 me-1"></i>{{ event['Time'] }}
                                </small>
                                <br>
                                <small class="text-muted">
                                    <i class="fas fa-map-marker-alt me-1"></i>{{ event['Location'] }}
                                </small>
                            </div>
                            {% endfor %}
                        {% else %}
                            <p class="text-muted mb-0">No upcoming events scheduled.</p>
                        {% endif %}
                    {% else %}
                        <p class="text-muted mb-0">No events added yet.</p>
                    {% endif %}
                </div>
            </div>
        </div>
        
        <div class="col-md-8 mb-4">
            <div class="card slide-in-right">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-calendar-alt me-2"></i>Event Calendar
                    </h5>
                </div>
                <div class="card-body">
                    <div id="calendar"></div>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-12">
            <div class="card fade-in-up">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        <i class="fas fa-list me-2"></i>All Events
                    </h5>
                    <a href="{{ url_for('download_events') }}" class="btn btn-outline-primary btn-sm">
                        <i class="fas fa-download me-1"></i>Download CSV
                    </a>
                </div>
                <div class="card-body">
                    {% if events %}
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>Event Name</th>
                                    <th>Date</th>
                                    <th>Time</th>
                                    <th>Location</th>
                                    <th>Description</th>
                                    <th width="100">Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for event in events %}
                                <tr>
                                    <td><strong>{{ event['Event Name'] }}</strong></td>
                                    <td>{{ event['Date'] }}</td>
                                    <td>{{ event['Time'] }}</td>
                                    <td>{{ event['Location'] }}</td>
                                    <td>{{ event['Description'][:50] }}{% if event['Description']|length > 50 %}...{% endif %}</td>
                                    <td>
                                        <form method="POST" action="{{ url_for('delete_event', event_id=event['ID']) }}" 
                                              style="display: inline;" onsubmit="return confirm('Are you sure you want to delete this event?')">
                                            <button type="submit" class="btn btn-delete" title="Delete Event">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        </form>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <div class="text-center py-4">
                        <i class="fas fa-calendar-plus fa-3x text-muted mb-3"></i>
                        <p class="text-muted">No events scheduled yet. Add your first event above!</p>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Set today's date as default
document.getElementById('date').valueAsDate = new Date();

// Initialize FullCalendar
document.addEventListener('DOMContentLoaded', function() {
    const calendarEl = document.getElementById('calendar');
    
    const calendar = new FullCalendar.Calendar(calendarEl, {
        initialView: 'dayGridMonth',
        headerToolbar: {
            left: 'prev,next today',
            center: 'title',
            right: 'dayGridMonth,timeGridWeek,listWeek'
        },
        height: 'auto',
        events: '/api/events',
        eventDisplay: 'block',
        eventColor: '#6f42c1',
        eventTextColor: '#ffffff',
        eventClick: function(info) {
            // Show event details in a modal or alert
            const event = info.event;
            const details = `
Event: ${event.title}
Date: ${event.start.toLocaleDateString()}
Time: ${event.start.toLocaleTimeString()}
Location: ${event.extendedProps.location || 'Not specified'}
Description: ${event.extendedProps.description || 'No description'}
            `;
            alert(details);
        },
        eventMouseEnter: function(info) {
            info.el.style.cursor = 'pointer';
            info.el.title = `${info.event.title}\n${info.event.extendedProps.description || ''}`;
        },
        dayCellDidMount: function(info) {
            // Add hover effect to calendar cells
            info.el.addEventListener('mouseenter', function() {
                this.style.backgroundColor = 'rgba(111, 66, 193, 0.1)';
            });
            info.el.addEventListener('mouseleave', function() {
                this.style.backgroundColor = '';
            });
        }
    });
    
    calendar.render();
    
    // Refresh calendar when new event is added
    document.getElementById('eventForm').addEventListener('submit', function() {
        setTimeout(() => {
            calendar.refetchEvents();
        }, 1000);
    });
});

// Form validation
document.getElementById('eventForm').addEventListener('submit', function(e) {
    const date = new Date(document.getElementById('date').value);
    const today = new Date();
    today.setHours(0, 0, 0, 0);
    
    if (date < today) {
        e.preventDefault();
        showToast('Event date cannot be in the past!', 'warning');
        return false;
    }
});

// Add visual feedback for form inputs
document.querySelectorAll('#eventForm input, #eventForm textarea').forEach(input => {
    input.addEventListener('focus', function() {
        this.parentElement.style.transform = 'translateY(-2px)';
        this.parentElement.style.transition = 'transform 0.3s ease';
    });
    
    input.addEventListener('blur', function() {
        this.parentElement.style.transform = 'translateY(0)';
    });
});
</script>
{% endblock %}

